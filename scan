#!/bin/bash
# scan - Quick scan from ScanSnap ix500 to PDF
# Output: ~/Documents/scanner-inbox/scan-YYYY-MM-DD-HHMMSS.pdf
#
# Features:
# - A4 page size
# - Duplex (both sides)
# - Auto-skip blank pages (back sides)
# - Multi-page batch to single PDF
# - Image-only PDF (OCR/correction can happen downstream)

set -e

# Some iX500 units/backends can clip a tiny amount on the right/bottom when
# scanning exactly A4 dimensions. Add a small bleed margin to avoid cutoff.
BLEED_MM=10
PAGE_WIDTH_MM=$((210 + BLEED_MM))
PAGE_HEIGHT_MM=$((297 + BLEED_MM))

# Auto-detect scanner device
# DEVICE=$(scanimage -L 2>/dev/null | grep -oP "fujitsu:ScanSnap iX500:\d+" | head -1)
# if [ -z "$DEVICE" ]; then
#     echo "Error: ScanSnap iX500 not found. Is it connected and powered on?"
#     exit 1
# fi

# speed up by avoiding detection:
DEVICE="fujitsu:ScanSnap iX500:1237052"

OUTDIR="$HOME/Documents/scanner-inbox"
TIMESTAMP=$(date '+%Y-%m-%d-%H%M%S')
TMPDIR=$(mktemp -d -p "$HOME" ix500.XXXXXX)
OUTFILE="$OUTDIR/scan-$TIMESTAMP.pdf"

# Ensure output directory exists
mkdir -p "$OUTDIR"

# Optional: custom filename as argument
if [ -n "$1" ]; then
    OUTFILE="$OUTDIR/$1.pdf"
fi

cleanup() {
    rm -rf "$TMPDIR"
}
trap cleanup EXIT

echo "Scanning (duplex, grayscale, A4)..."
scanimage --device "$DEVICE" \
    --format=tiff \
    --resolution 300 \
    --mode Gray \
    --source "ADF Duplex" \
    --page-width "$PAGE_WIDTH_MM" \
    --page-height "$PAGE_HEIGHT_MM" \
    --swskip 20 \
    --swcrop=yes \
    --swdespeck 2 \
    --overscan On \
    --prepick On \
    --buffermode On \
    --batch="$TMPDIR/page-%04d.tiff" \
    --batch-count=-1 \
    2>&1 | grep -v "^$" || true

# Count scanned pages
PAGECOUNT=$(ls -1 "$TMPDIR"/page-*.tiff 2>/dev/null | wc -l)

if [ "$PAGECOUNT" -eq 0 ]; then
    echo "No pages scanned (feeder empty?)"
    exit 1
fi

echo "Scanned $PAGECOUNT page(s)"

echo "Creating PDF..."

# Create a single multi-page, image-only PDF.
# Force 300 DPI metadata for predictable page sizing.
# Use grayscale + lossless compression to preserve OCR detail.
magick "$TMPDIR"/page-*.tiff -colorspace Gray -depth 8 -units PixelsPerInch -density 300 -compress Zip "$OUTFILE"

# Show final file size
FILESIZE=$(ls -lh "$OUTFILE" | awk '{print $5}')
echo "Done: $OUTFILE ($PAGECOUNT pages, $FILESIZE)"
